{% extends 'CUSTApp/AdminDashboard/base.html' %}

{% load static %}

{%block extra_css %}
<style>
    :root {
        --primary-color: #0A369D;
        --primary-light: #1E88E5;
        --primary-dark: #082d7d;
        --secondary-color: #4472CA;
        --accent-color: #5E7CE2;
        --success-color: #10B981;
        --warning-color: #F59E0B;
        --error-color: #EF4444;
        --info-color: #3B82F6;
        --gray-50: #F9FAFB;
        --gray-100: #F3F4F6;
        --gray-200: #E5E7EB;
        --gray-300: #D1D5DB;
        --gray-400: #9CA3AF;
        --gray-500: #6B7280;
        --gray-600: #4B5563;
        --gray-700: #374151;
        --gray-800: #1F2937;
        --gray-900: #111827;
        --white: #FFFFFF;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --radius-sm: 0.375rem;
        --radius: 0.5rem;
        --radius-md: 0.75rem;
        --radius-lg: 1rem;
        --radius-xl: 1.5rem;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: var(--gray-50);
        color: var(--gray-800);
        line-height: 1.6;
    }

    .main-content {
        padding: 1.5rem;
    }

    /* Modern Card Design */
    .card {
        background: var(--white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        transition: var(--transition);
        margin-bottom: 2rem;
    }

    .card:hover {
        box-shadow: var(--shadow-xl);
        transform: translateY(-2px);
    }

    .card-header-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: var(--white);
        padding: 2rem 2rem 1.5rem 2rem;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .card-header-primary::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(30px, -30px);
    }

    .card-header-primary::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 150px;
        height: 150px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: translate(-50px, 50px);
    }

    .card-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .card-category {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0;
        position: relative;
        z-index: 1;
        font-weight: 300;
    }

    .card-body {
        padding: 1.5rem 2rem 2rem 2rem;
    }

    /* Enhanced Button Styling */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        text-transform: none;
        letter-spacing: 0.025em;
        position: relative;
        overflow: hidden;
        white-space: nowrap;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        min-width: 80px;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: var(--white);
        box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: var(--white);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--error-color) 0%, #F87171 100%);
        color: var(--white);
        box-shadow: var(--shadow-md);
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #DC2626 0%, var(--error-color) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: var(--white);
    }

    .btn-secondary {
        background: var(--gray-600);
        color: var(--white);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary:hover {
        background: var(--gray-700);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: var(--white);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn i {
        font-size: 1rem;
    }

    .btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.2);
    }

    /* DataTable Enhancements */
    .table-responsive {
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow);
        margin-bottom: 0;
    }

    .table {
        margin: 0;
        background: var(--white);
        font-size: 0.875rem;
    }

    .table thead th {
        background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        border: none;
        padding: 1rem 0.75rem;
        font-weight: 600;
        color: var(--gray-700);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.75rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table tbody td {
        padding: 1rem 0.75rem;
        border-top: 1px solid var(--gray-200);
        vertical-align: middle;
        color: var(--gray-600);
    }

    .table tbody tr {
        transition: var(--transition);
    }

    .table tbody tr:hover {
        background: var(--gray-50);
        transform: scale(1.005);
    }

    /* DataTables Custom Styling */
    .dataTables_wrapper {
        padding: 0;
    }

    .dataTables_length,
    .dataTables_filter {
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dataTables_length label,
    .dataTables_filter label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--gray-700);
        margin: 0;
    }

    .dataTables_length select,
    .dataTables_filter input {
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-md);
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        transition: var(--transition);
        background: var(--white);
    }

    .dataTables_length select:focus,
    .dataTables_filter input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.1);
    }

    .dataTables_info {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin-top: 1rem;
    }

    .dataTables_paginate {
        margin-top: 1rem;
    }

    .dataTables_paginate .paginate_button {
        padding: 0.5rem 0.75rem;
        margin: 0 0.125rem;
        border-radius: var(--radius);
        border: 1px solid var(--gray-300);
        background: var(--white);
        color: var(--gray-600);
        transition: var(--transition);
        text-decoration: none;
    }

    .dataTables_paginate .paginate_button:hover {
        background: var(--primary-color);
        color: var(--white);
        border-color: var(--primary-color);
        text-decoration: none;
    }

    .dataTables_paginate .paginate_button.current {
        background: var(--primary-color);
        color: var(--white);
        border-color: var(--primary-color);
    }

    /* Action Buttons Container */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: flex-start;
        flex-wrap: wrap;
    }

    /* Modal Enhancements */
    .modal-content {
        border-radius: var(--radius-xl);
        border: none;
        box-shadow: var(--shadow-xl);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: var(--white);
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        padding: 1.5rem 2rem;
        border-bottom: none;
    }

    .modal-title {
        font-weight: 600;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1.5rem 2rem;
        border-top: 1px solid var(--gray-200);
        background: var(--gray-50);
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    }

    .close {
        background: transparent;
        border: none;
        color: var(--white);
        opacity: 0.8;
        font-size: 1.5rem;
        padding: 0;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
    }

    .close:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.1);
    }

    /* Form Styling */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-md);
        background-color: var(--white);
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.1);
        background-color: var(--white);
    }

    .form-control:hover {
        border-color: var(--gray-300);
    }

    .form-control::placeholder {
        color: var(--gray-400);
    }

    /* CKEditor Container */
    .editor-container {
        margin-bottom: 2rem;
    }

    #updateContent {
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        min-height: 300px;
        transition: var(--transition);
    }

    #updateContent:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.1);
    }

    /* Enhanced CKEditor Styling */
    .ck-editor__editable {
        min-height: 300px !important;
        padding: 1.5rem !important;
        font-size: 1rem !important;
        line-height: 1.6 !important;
        border-radius: var(--radius-lg) !important;
    }

    .ck-toolbar {
        border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
        border-color: var(--gray-200) !important;
        background: var(--gray-50) !important;
    }

    /* Content Preview */
    .content-preview {
        max-width: 300px;
        max-height: 60px;
        overflow: hidden;
        position: relative;
        font-size: 0.875rem;
        line-height: 1.4;
        color: var(--gray-600);
    }

    .content-preview::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 15px;
        background: linear-gradient(transparent, var(--white));
    }

    /* Loading States */
    .loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid var(--gray-200);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        transform: translate(-50%, -50%);
    }

    @keyframes spin {
        to {
            transform: translate(-50%, -50%) rotate(360deg);
        }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .card-body {
            padding: 1.25rem 1.5rem 1.75rem 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }

        .card-header-primary {
            padding: 1.5rem 1.5rem 1rem 1.5rem;
        }

        .card-body {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .action-buttons {
            flex-direction: column;
            align-items: stretch;
            width: 100%;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
        }

        .table-responsive {
            font-size: 0.75rem;
        }

        .table thead th,
        .table tbody td {
            padding: 0.5rem 0.25rem;
        }

        /* Stack action buttons vertically on mobile */
        .action-buttons .btn-sm {
            font-size: 0.65rem;
            padding: 0.375rem 0.75rem;
        }
    }

    @media (max-width: 576px) {
        .card-title {
            font-size: 1.25rem;
        }

        .dataTables_length,
        .dataTables_filter {
            flex-direction: column;
            align-items: flex-start;
        }

        .content-preview {
            max-width: 200px;
            max-height: 40px;
        }
    }

    /* Animation for elements */
    .card {
        animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* CKEditor enhancements */
    .ck-editor__editable {
        min-height: 250px !important;
        border-radius: var(--radius-md) !important;
    }

    .ck-toolbar {
        border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
    }

    /* Better spacing */
    .dataTables_top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
</style>
</style>
{%endblock%}
{%block content%}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">
                    <i class="material-icons">description</i>
                    Application Templates
                </h4>
                <p class="card-category">View, update, download, or delete application templates</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="templatesTable" class="table table-striped" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Template Name</th>
                                <th>Content Preview</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal for Updating Application Template -->
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">
                    <i class="material-icons">edit</i>
                    Update Application Template
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateForm">
                    <input type="hidden" id="updateId">
                    <div class="form-group">
                        <label for="updateName">
                            <i class="material-icons"
                                style="font-size: 16px; vertical-align: middle; margin-right: 4px;">title</i>
                            Template Name
                        </label>
                        <input type="text" class="form-control" id="updateName" placeholder="Enter template name"
                            required>
                    </div>
                    <div class="editor-container">
                        <div class="form-group">
                            <label for="updateContent">
                                <i class="material-icons"
                                    style="font-size: 16px; vertical-align: middle; margin-right: 4px;">edit</i>
                                Template Content
                            </label>
                            <div id="updateContent"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="material-icons">close</i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="updateTemplate()">
                    <i class="material-icons">save</i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{%endblock%}
{%block extra_js%}
<!-- Load Scripts -->
<script src="{% static 'assets/js/core/jquery.min.js' %}"></script>
<script src="{% static 'assets/js/core/popper.min.js' %}"></script>
<script src="{% static 'assets/js/core/bootstrap-material-design.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/perfect-scrollbar.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/moment.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/sweetalert2.js' %}"></script>
<script src="{% static 'assets/js/plugins/jquery.validate.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/jquery.bootstrap-wizard.js' %}"></script>
<script src="{% static 'assets/js/plugins/bootstrap-selectpicker.js' %}"></script>
<script src="{% static 'assets/js/plugins/bootstrap-datetimepicker.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/jquery.dataTables.min.js' %}"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
<script src="{% static 'assets/js/plugins/bootstrap-tagsinput.js' %}"></script>
<script src="{% static 'assets/js/plugins/jasny-bootstrap.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/fullcalendar.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/jquery-jvectormap.js' %}"></script>
<script src="{% static 'assets/js/plugins/nouislider.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script>
<script src="{% static 'assets/js/plugins/arrive.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/chartist.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/bootstrap-notify.js' %}"></script>
<script src="{% static 'assets/js/material-dashboard.js' %}?v=2.2.2" type="text/javascript"></script>
<script src="{% static 'js/auth.js' %}" type="text/javascript"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>

<script>
    let updateEditor = null;

    $(document).ready(function () {
        // Check authentication
        if (!checkAuth(requiredUserType = 'admin')) return;

        // Initialize DataTable
        const table = $('#templatesTable').DataTable({
            ajax: {
                url: '/api/application/',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                dataSrc: function (json) {
                    console.log('Templates data received:', json);
                    if (json.error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Loading Error',
                            text: json.error,
                            confirmButtonColor: '#EF4444'
                        });
                        return [];
                    }
                    return json;
                },
                error: function (xhr, error, thrown) {
                    console.error('DataTables AJAX error:', xhr.responseText);
                    Swal.fire({
                        icon: 'error',
                        title: 'Loading Failed',
                        text: 'Failed to load templates: ' + error,
                        confirmButtonColor: '#EF4444'
                    });
                }
            },
            columns: [
                { data: 'id', title: 'ID' },
                { 
                    data: 'application_name', 
                    title: 'Template Name',
                    render: function(data) {
                        return `<strong style="color: var(--gray-800);">${data || 'Untitled'}</strong>`;
                    }
                },
                {
                    data: 'application_desc',
                    title: 'Content Preview',
                    render: function (data) {
                        if (!data) return '<em style="color: var(--gray-400);">No content</em>';

                        // Create a temporary div to strip HTML tags
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = data;
                        const text = tempDiv.textContent || tempDiv.innerText || '';

                        // Return truncated text with preview styling
                        const truncated = text.length > 120 ? text.substr(0, 120) + '...' : text;
                        return `<div class="content-preview" title="${text}">${truncated}</div>`;
                    }
                },
                {
                    data: 'created_at',
                    title: 'Created At',
                    render: function (data) {
                        if (!data) return '<em style="color: var(--gray-400);">N/A</em>';
                        const date = new Date(data);
                        return `<span style="color: var(--gray-600);">${date.toLocaleDateString()}</span>`;
                    }
                },
                {
                    data: null,
                    title: 'Actions',
                    orderable: false,
                    render: function (data, type, row) {
                        return `
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="showUpdateModal(${row.id})" title="Edit Template">
                                    <i class="material-icons">edit</i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${row.id})" title="Delete Template">
                                    <i class="material-icons">delete</i> Delete
                                </button>
                            </div>
                        `;
                    }
                }
            ],
            dom: '<"dataTables_top"lf>rt<"bottom"ip>',
            responsive: true,
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search templates...",
                lengthMenu: "Show _MENU_ templates",
                info: "Showing _START_ to _END_ of _TOTAL_ templates",
                infoEmpty: "No templates found",
                infoFiltered: "(filtered from _MAX_ total)",
                zeroRecords: "No matching templates found",
                emptyTable: "No templates available"
            },
            columnDefs: [
                { targets: [0], visible: false }, // Hide ID column
                { targets: [1], width: "25%", className: "text-left" },
                { targets: [2], width: "40%", className: "text-left" },
                { targets: [3], width: "15%", className: "text-center" },
                { targets: [4], width: "20%", className: "text-center" }
            ],
            pageLength: 10,
            lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            order: [[3, 'desc']], // Sort by created date descending
            drawCallback: function() {
                // Ensure tooltips work after table redraw
                $('[title]').tooltip();
            }
        });

        // Logout functionality
        $('#logoutButton').on('click', function (e) {
            e.preventDefault();
            logout();
        });

        console.log('Templates page initialized');
    });

    function showUpdateModal(id) {
        // First fetch the template data
        $.ajax({
            url: `/api/application/${id}/`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(template) {
                $('#updateId').val(template.id);
                $('#updateName').val(template.application_name || '');

                // Destroy existing editor if it exists
                if (updateEditor) {
                    updateEditor.destroy().then(() => {
                        console.log('Previous editor destroyed');
                        createNewEditor(template.id, template.application_name, template.application_desc);
                    }).catch(err => {
                        console.error('Error destroying editor:', err);
                        createNewEditor(template.id, template.application_name, template.application_desc);
                    });
                } else {
                    createNewEditor(template.id, template.application_name, template.application_desc);
                }
            },
            error: function(xhr) {
                console.error('Error fetching template:', xhr);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load template data',
                    confirmButtonColor: '#EF4444'
                });
            }
        });
    }

    function createNewEditor(id, name, content) {
        ClassicEditor
            .create(document.querySelector('#updateContent'), {
                toolbar: [
                    'heading', '|',
                    'bold', 'italic', 'underline', 'strikethrough', '|',
                    'fontColor', 'fontBackgroundColor', '|',
                    'alignment', '|',
                    'numberedList', 'bulletedList', '|',
                    'outdent', 'indent', '|',
                    'link', 'insertTable', 'code', '|',
                    'undo', 'redo'
                ],
                table: {
                    contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                },
                height: 300
            })
            .then(editor => {
                updateEditor = editor;
                editor.setData(content || '');
                $('#updateModal').modal('show');
                console.log('New editor created and modal shown');
            })
            .catch(error => {
                console.error('CKEditor initialization failed:', error);
                alert({
                    icon: 'error',
                    title: 'Editor Error',
                    text: 'Failed to load editor: ' + error.message,
                    confirmButtonColor: '#EF4444'
                });
            });
    }

    function updateTemplate() {
        if (!updateEditor) {
            Swal.fire({
                icon: 'error',
                title: 'Editor Not Ready',
                text: 'Editor not initialized. Please try again.',
                confirmButtonColor: '#EF4444'
            });
            return;
        }

        const id = $('#updateId').val();
        const name = $('#updateName').val().trim();
        const content = updateEditor.getData().trim();

        if (!name || !content) {
            Swal.fire({
                icon: 'error',
                title: 'Missing Information',
                text: 'Please fill in both name and content.',
                confirmButtonColor: '#EF4444'
            });
            return;
        }

        // Add loading state
        const saveBtn = $('.btn-primary');
        const originalText = saveBtn.html();
        saveBtn.prop('disabled', true).html('<i class="material-icons">hourglass_empty</i> Saving...');

        $.ajax({
            url: '/api/application/' + id + '/',
            method: 'PATCH',
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: JSON.stringify({
                application_name: name,
                application_desc: content
            }),
            success: function (response) {
                saveBtn.prop('disabled', false).html(originalText);
                if (response && (response.id || response.application_name)) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Template Updated',
                        text: (response.application_name || name) + ' updated successfully!',
                        confirmButtonColor: '#10B981',
                        timer: 2000,
                        timerProgressBar: true
                    });
                    $('#updateModal').modal('hide');
                    $('#templatesTable').DataTable().ajax.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Update Failed',
                        text: response.error || 'Unexpected response format',
                        confirmButtonColor: '#EF4444'
                    });
                }
            },
            error: function (xhr, status, error) {
                saveBtn.prop('disabled', false).html(originalText);
                console.error('Update error:', xhr.responseText);
                
                let errorMsg = 'Failed to update template';
                if (xhr.responseJSON) {
                    if (xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    } else if (xhr.responseJSON.detail) {
                        errorMsg = xhr.responseJSON.detail;
                    }
                } else if (xhr.status === 403) {
                    errorMsg = 'You do not have permission to update this template';
                } else if (xhr.status === 404) {
                    errorMsg = 'Template not found';
                } else if (xhr.status === 400) {
                    errorMsg = 'Invalid data provided';
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Update Failed',
                    text: errorMsg,
                    confirmButtonColor: '#EF4444'
                });
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function deleteTemplate(id) {
        Swal.fire({
            title: 'Delete Template',
            text: "Are you sure you want to delete this template? This action cannot be undone!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                console.log('Sending delete request for ID:', id);
                
                // Show loading
                Swal.fire({
                    title: 'Deleting...',
                    text: 'Please wait while we delete the template.',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                $.ajax({
                    url: `/api/application/${id}/`,
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function (response) {
                        console.log('Delete response:', response);
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: response.message || response.success || 'Template has been deleted successfully.',
                            confirmButtonColor: '#10B981',
                            timer: 2000,
                            timerProgressBar: true
                        });
                        $('#templatesTable').DataTable().ajax.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error('Delete AJAX error:', xhr.responseText, 'Status:', status);
                        
                        let errorMsg = 'Failed to delete template';
                        if (xhr.responseJSON) {
                            if (xhr.responseJSON.error) {
                                errorMsg = xhr.responseJSON.error;
                            } else if (xhr.responseJSON.detail) {
                                errorMsg = xhr.responseJSON.detail;
                            }
                        } else if (xhr.status === 403) {
                            errorMsg = 'You do not have permission to delete this template';
                        } else if (xhr.status === 404) {
                            errorMsg = 'Template not found';
                        }

                        Swal.fire({
                            icon: 'error',
                            title: 'Delete Failed',
                            text: errorMsg,
                            confirmButtonColor: '#EF4444'
                        });
                    }
                });
            }
        });
    }

    // Clean up editor when modal is hidden
    $('#updateModal').on('hidden.bs.modal', function () {
        if (updateEditor) {
            updateEditor.destroy().then(() => {
                updateEditor = null;
                console.log('Editor cleaned up');
            }).catch(err => {
                console.error('Error cleaning up editor:', err);
            });
        }
    });
</script>
{%endblock%}