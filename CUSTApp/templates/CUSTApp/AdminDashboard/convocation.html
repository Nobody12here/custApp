{% extends 'CUSTApp/AdminDashboard/base.html' %}
{% load static %}

{% block title %}Convocation Management{% endblock %}

{% block extra_css %}
<style>
    /* Ensure dropdown menu always has enough height */
    .dropdown-menu {
        min-height: 48px;
    }
</style>
<style>
    .datetime-modification select.form-control {
        margin-bottom: 0;
    }

    .modal-header .close {
        padding: 0.5rem 1rem;
        margin: -1rem -1rem -1rem auto;
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        opacity: 0.8;
        background: none;
        border: none;
        transition: opacity 0.3s ease;
    }

    .modal-header .close:hover {
        opacity: 1;
        color: #000;
        cursor: pointer;
    }

    /* Base Styles */
    .card-stats {
        cursor: pointer;
        transition: transform 0.2s;
        min-width: 220px;
        max-width: 300px;
    }

    /* Form Styles */
    .convocation-form {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.14);
        margin-bottom: 30px;
    }

    .convocation-form .form-group {
        margin-bottom: 1rem;
    }

    .convocation-form label {
        color: #555;
        font-weight: 500;
    }

    .convocation-form .form-control {
        border-radius: 4px;
        border: 1px solid #ddd;
        padding: 10px 12px;
        height: auto;
    }

    .convocation-form .form-control:focus {
        border-color: #0A369D;
        box-shadow: 0 0 0 0.2rem rgba(10, 54, 157, 0.25);
    }

    /* Table Styles */
    .table th {
        font-weight: 500;
        color: #0A369D;
    }

    /* Button Styles */
    .btn {
        padding: 8px 16px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .btn i.material-icons {
        font-size: 18px;
        vertical-align: middle;
    }

    /* Status Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        text-transform: capitalize;
        font-size: 13px;
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }

    .status-badge.active {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.inactive {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-badge.upcoming {
        background-color: #fff3cd;
        color: #856404;
    }

    /* Modal Styles */
    .modal-content {
        border: none;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        border-bottom: 1px solid #eee;
        padding: 20px;
    }

    .modal-title {
        font-weight: 600;
        color: #0A369D;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        border-top: 1px solid #eee;
        padding: 15px 20px;
    }

    /* Detail Items */
    .detail-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #0A369D;
    }

    .detail-item h6 {
        color: #0A369D;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #dee2e6;
    }

    .detail-item p {
        margin-bottom: 10px;
        display: flex;
    }

    .detail-item p strong {
        min-width: 120px;
        display: inline-block;
    }

    /* Enhanced Input Fields */
    .convocation-form .form-control {
        border-radius: 6px;
        border: 2px solid #ddd;
        padding: 8px 12px;
        height: auto;
        font-size: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .convocation-form .form-control:focus {
        border-color: #0A369D;
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.15);
        outline: none;
    }

    /* Form Group Enhancements */
    .convocation-form .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .convocation-form label {
        color: #555;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 14px;
        letter-spacing: 0.5px;
    }

    /* Textarea Styling */
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    /* Search Input Enhancement */
    #searchInput {
        border-radius: 30px;
        border: 2px solid #ddd;
        padding: 10px 20px;
        font-size: 15px;
        transition: all 0.3s ease;
    }

    #searchInput:focus {
        border-color: #0A369D;
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.15);
        outline: none;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .detail-item p {
            flex-direction: column;
        }

        .detail-item p strong {
            min-width: auto;
            margin-bottom: 5px;
        }
    }

    /* Animation for form toggle */
    #ConvocationFormRow {
        transition: all 0.3s cubic-bezier(.4, 0, .2, 1);
    }

    .form-control.is-invalid {
        border-color: #dc3545;
    }

    .form-control.is-valid {
        border-color: #28a745;
    }

    .invalid-feedback {
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
        display: block;
    }

    .valid-feedback {
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #28a745;
        display: block;
    }

    /* Student Upload Section */
    .student-upload-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 2px dashed #ddd;
        transition: border-color 0.3s ease;
    }

    .student-upload-section:hover {
        border-color: #0A369D;
    }

    .student-upload-section.dragover {
        border-color: #0A369D;
        background-color: rgba(10, 54, 157, 0.05);
    }

    .btn-upload {
        width: 100%;
        height: 45px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-upload:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-upload:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .upload-status .alert {
        margin-bottom: 0;
        border-radius: 6px;
        font-size: 14px;
    }

    .upload-progress {
        margin-top: 10px;
    }

    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
    }

    .progress-bar {
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    /* File input styling */
    input[type="file"].form-control {
        padding: 10px 12px;
        border: 2px solid #ddd;
        background: white;
        cursor: pointer;
    }

    input[type="file"].form-control:focus {
        border-color: #0A369D;
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.15);
    }

    input[type="file"].form-control::file-selector-button {
        background: #0A369D;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        margin-right: 12px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s ease;
    }

    input[type="file"].form-control::file-selector-button:hover {
        background: #1E88E5;
    }

    /* Dropdown Styles */
    .dropdown-toggle::after {
        display: none;
    }

    .dropdown-menu {
        border-radius: 6px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        border: none;
        padding: 0.5rem 0;
        min-width: 180px;
        min-height: 48px;
    }

    .dropdown-item {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 14px;
        transition: all 0.2s ease;
        color: #222 !important;
        background-color: #fff !important;
    }

    .dropdown-item:hover {
        background-color: #e3e8f0 !important;
        color: #0A369D !important;
        font-weight: 600;
    }

    .dropdown-item i.material-icons {
        font-size: 18px;
    }

    /* Badge Styles for Student Status */
    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-success {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-primary {
        background-color: #cce7ff;
        color: #004085;
    }

    .badge-info {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .badge-secondary {
        background-color: #e2e3e5;
        color: #383d41;
    }

    /* Convocation instance table body */

    #convocationTableBody>tr>td {
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<!-- Add New Convocation Button -->
<div class="row">
    <div class="col-md-12 text-right mb-3 mt-3">
        <button id="toggleConvocationForm" class="btn btn-primary">
            <i class="material-icons">add</i> Add New Convocation Instance
        </button>
    </div>
</div>

<!-- Add New Convocation Form (hidden by default) -->
<div class="row" id="ConvocationFormRow" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Add Convocation</h4>
                <p class="card-category">Enter convocation details to create a new instance</p>
            </div>
            <div class="card-body">
                <form id="convocationForm" class="convocation-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="convocationTitle">Convocation Title</label>
                                <input type="text" class="form-control" id="convocationTitle" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="academicYear">Academic Year</label>
                                <input type="text" class="form-control" id="academicYear" placeholder="e.g., 2023-2024"
                                    required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="registrationDate">Registration Start Date</label>
                                <input type="date" class="form-control" id="registrationDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="registrationDeadline">Registration Deadline</label>
                                <input type="date" class="form-control" id="registrationDeadline" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rehearsalDate">Rehearsal Date</label>
                                <input type="date" class="form-control" id="rehearsalDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rehearsalTime">Rehearsal Time</label>
                                <input type="time" class="form-control" id="rehearsalTime" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="convocationDate">Convocation Date</label>
                                <input type="date" class="form-control" id="convocationDate" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="description">Description (Optional)</label>
                                <textarea class="form-control" id="description" rows="3"
                                    placeholder="Enter convocation description..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <button type="submit" class="btn btn-primary">
                            <i class="material-icons">send</i> Create Convocation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Convocation Instances Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Convocation Instances</h4>
                <p class="card-category">Manage all convocation instances</p>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="form-group mb-0">
                            <input type="text" class="form-control" id="searchInput"
                                placeholder="Search convocations...">
                        </div>
                    </div>
                    <div class="col-md-4 text-right">
                        <button id="filterActive" class="btn btn-info">
                            <i class="material-icons">check_circle</i> Active Only
                        </button>
                        <button id="clearFilters" class="btn btn-secondary ml-2">
                            <i class="material-icons">clear</i> Clear Filters
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-hover text-center mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Title</th>
                                <th>Academic Year</th>
                                <th>Registration Deadline</th>
                                <th>Rehearsal Date</th>
                                <th>Status</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="convocationTableBody">
                            <!-- Convocation instances will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" role="dialog" aria-labelledby="viewDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailsModalLabel">Convocation Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-item">
                            <h6>General Information</h6>
                            <p><strong>Title:</strong> <span id="detail-title"></span></p>
                            <p><strong>Academic Year:</strong> <span id="detail-academic-year"></span></p>
                            <p><strong>Status:</strong> <span id="detail-status"></span></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-item">
                            <h6>Important Dates</h6>
                            <p><strong>Registration Start:</strong> <span id="detail-registration-date"></span></p>
                            <p><strong>Registration Deadline:</strong> <span id="detail-registration-deadline"></span>
                            </p>
                            <p><strong>Rehearsal:</strong> <span id="detail-rehearsal-datetime"></span></p>
                            <p><strong>Convocation :</strong> <span id="detail-convocation-datetime"></span></p>

                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="detail-item">
                            <h6>Additional Information</h6>
                            <p><strong>Registration Form:</strong> <a id="detail-form-link" href="#"
                                    target="_blank">Open Form</a></p>
                            <p><strong>Description:</strong> <span id="detail-description"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Student Data Upload Modal -->
<div class="modal fade" id="studentUploadModal" tabindex="-1" role="dialog" aria-labelledby="studentUploadModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentUploadModalLabel">
                    <i class="material-icons" style="vertical-align: middle;">cloud_upload</i>
                    Student Data Upload
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="detail-item py-2 px-3 mb-3"
                            style="display: flex; align-items: center; gap: 2rem; background: #f8f9fa; border-left: 4px solid #0A369D;">
                            <span><strong>Title:</strong> <span id="upload-convocation-title"></span></span>
                            <span><strong>Academic Year:</strong> <span id="upload-academic-year"></span></span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="modalStudentDataFile">Select Student Data File</label>
                            <div class="modal-student-upload-section">
                                <div class="row">
                                    <div class="col-md-8">
                                        <input type="file" class="form-control" id="modalStudentDataFile"
                                            accept=".csv,.xlsx,.xls" placeholder="Select student data file...">
                                        <small class="form-text text-muted">
                                            Supported formats: CSV, Excel (.xlsx, .xls). File should contain student
                                            information including registration numbers, names, and convocation details.
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-primary btn-upload"
                                            id="modalUploadStudentDataBtn">
                                            <i class="material-icons">cloud_upload</i> Upload File
                                        </button>
                                    </div>
                                </div>
                                <div class="upload-status" id="modalUploadStatus" style="display: none;">
                                    <div class="alert alert-info mt-2" role="alert">
                                        <span id="modalUploadStatusMessage"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assigned Students Table -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="detail-item">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Assigned Students</h6>
                                <div class="d-flex align-items-center gap-2">
                                    <button type="button" class="btn btn-sm btn-success" id="addStudentBtn"
                                        data-toggle="modal" data-target="#studentSearchModal">
                                        <i class="material-icons">person_add</i> Add Student
                                    </button>
                                    <button type="button" class="btn btn-sm btn-info ml-2" id="refreshStudentsBtn">
                                        <i class="material-icons">refresh</i> Refresh List
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>S.No</th>
                                            <th>Registration No</th>
                                            <th>Student Name</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assignedStudentsTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <i class="material-icons">hourglass_empty</i>
                                                Loading students...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    Total Students: <span id="totalStudentsCount" class="font-weight-bold">0</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Search Table for Adding -->

                <!-- Student Search Modal (for adding students to convocation) -->
                <div class="modal fade" id="studentSearchModal" tabindex="-1" role="dialog"
                    aria-labelledby="studentSearchModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="studentSearchModalLabel">
                                    <i class="material-icons" style="vertical-align: middle;">person_add</i>
                                    Add Student to Convocation
                                </h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group mb-3">
                                    <input type="text" class="form-control form-control-sm" id="studentSearchInput"
                                        placeholder="Search students by name, registration no, or email...">
                                </div>
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Registration No</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentSearchResultsBody">
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">Type to search
                                                    students...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Letter Generation Modal -->
<div class="modal fade" id="letterGenerationModal" tabindex="-1" role="dialog"
    aria-labelledby="letterGenerationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="letterGenerationModalLabel">
                    <i class="material-icons" style="vertical-align: middle;">description</i>
                    Convocation Letter Generation
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="detail-item py-2 px-3 mb-3"
                            style="display: flex; align-items: center; gap: 2rem; background: #f8f9fa; border-left: 4px solid #0A369D;">
                            <span><strong>Title:</strong> <span id="letter-convocation-title"></span></span>
                            <span><strong>Academic Year:</strong> <span id="letter-academic-year"></span></span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="modalApplicationLetterSelect">Select Application Letter Template</label>
                            <div class="detail-item">
                                <h6>Letter Generation Options</h6>
                                <div class="row">
                                    <div class="col-md-8">
                                        <select class="form-control" id="modalApplicationLetterSelect">
                                            <option value="">Select an application letter template...</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            Choose the application letter template that will be used for generating
                                            convocation letters. Only exam department applications are shown.
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-info btn-block"
                                            id="modalLoadApplicationsBtn">
                                            <i class="material-icons">refresh</i> Load Templates
                                        </button>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <span id="modalApplicationCount">0</span> templates available
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="generateConvocationLetterFromModal()">
                    <i class="material-icons">picture_as_pdf</i> Generate Letter Sample
                </button>

                <button type="button" class="btn btn-info" onclick="sendConvocationEmailsFromModal()">
                    <i class="material-icons">email</i> Send Email To all students
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/convocation.js' %}"></script>
<script>
    $(document).ready(function () {
        if (!checkAuth(requiredType = 'admin')) return;
        // Date validation on change
        $('#registrationDate, #registrationDeadline, #rehearsalDate, #convocationDate').on('change', function () {
            validateDates();
        });

        // Real-time validation for required fields
        $('input[required], select[required]').on('blur', function () {
            const value = $(this).val();
            const fieldId = $(this).attr('id');

            if (!value || value.trim() === '') {
                showValidationFeedback(fieldId, false, 'This field is required');
            } else {
                showValidationFeedback(fieldId, true, '');
            }
        });

        // URL validation
        $('#registrationFormLink').on('blur', function () {
            const url = $(this).val();
            if (url) {
                try {
                    new URL(url);
                    showValidationFeedback('registrationFormLink', true, '');
                } catch {
                    showValidationFeedback('registrationFormLink', false, 'Please enter a valid URL');
                }
            }
        });

        // Form submission
        $('#convocationForm').on('submit', function (e) {
            e.preventDefault();
            console.log('Form submitted');
            if (!validateForm()) {
                const firstInvalid = $('.is-invalid').first();
                if (firstInvalid.length) {
                    $('html, body').animate({
                        scrollTop: firstInvalid.offset().top - 100
                    }, 300);
                    firstInvalid.focus();
                }
                return false;
            }

            const formData = {
                title: $('#convocationTitle').val(),
                academic_year: $('#academicYear').val(),
                registration_date: $('#registrationDate').val(),
                registration_deadline: $('#registrationDeadline').val(),
                rehearsal_date: $('#rehearsalDate').val(),
                rehearsal_time: $('#rehearsalTime').val(),
                convocation_date: $('#convocationDate').val(),
                description: $('#description').val()
            };

            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.text();
            submitBtn.prop('disabled', true).text('Creating...');

            $.ajax({
                url: '/convocation/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: formData,
                success: function (response, textStatus, jqXHR) {
                    if (jqXHR.status === 201) {
                        alert('Convocation instance created successfully');
                        $('#convocationForm')[0].reset();
                        $('.is-valid, .is-invalid').removeClass('is-valid is-invalid');
                        $('.invalid-feedback, .valid-feedback').remove();
                        loadConvocations();
                        $('#ConvocationFormRow').slideUp();
                    } else {
                        alert(response.error || 'Failed to create convocation instance');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'An error occurred while creating the convocation instance';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    alert(errorMessage);
                },
                complete: function () {
                    submitBtn.prop('disabled', false).text(originalText);
                }
            });
        });

        // Search functionality
        $('#searchInput').on('input', function () {
            loadConvocations($(this).val());
        });

        // Filter buttons
        $('#filterActive').on('click', () => loadConvocations('', true));
        $('#clearFilters').on('click', () => loadConvocations('', false));

        // Toggle form
        $('#toggleConvocationForm').on('click', function () {
            $('#ConvocationFormRow').slideToggle(200);
        });

        // File input change handler
        $('#studentDataFile').on('change', function () {
            const file = this.files[0];
            console.log(file);
            $('#uploadStudentDataBtn').prop('disabled', !file);

            if (file) {
                // Hide any previous status
                $('#uploadStatus').hide();

                // Show file info
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const fileInfo = `Selected: ${file.name} (${fileSize} MB)`;
                $(this).next('.form-text').text(fileInfo);
            }
        });

        // Upload button click handler
        $('#uploadStudentDataBtn').on('click', function () {
            console.log('Upload button clicked');
            handleFileUpload();
        });

        // Drag and drop functionality
        const uploadSection = $('.student-upload-section');

        uploadSection.on('dragover', function (e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });

        uploadSection.on('dragleave', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });

        uploadSection.on('drop', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');

            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                $('#studentDataFile')[0].files = files;
                $('#uploadStudentDataBtn').prop('disabled', false);

                // Trigger change event to show file info
                $('#studentDataFile').trigger('change');
            }
        });

        // Reset upload section when modal is closed
        $('#viewDetailsModal').on('hidden.bs.modal', function () {
            $('#studentDataFile').val('');
            $('#uploadStudentDataBtn').prop('disabled', true);
            $('#uploadStatus').hide();
            $('.upload-progress').remove();
        });

        // Event handlers for new modal functionality

        // Student Upload Modal file input change handler
        $('#modalStudentDataFile').on('change', function () {
            const file = this.files[0];
            $('#modalUploadStudentDataBtn').prop('disabled', !file);

            if (file) {
                // Hide any previous status
                $('#modalUploadStatus').hide();

                // Show file info
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const fileInfo = `Selected: ${file.name} (${fileSize} MB)`;
                $(this).next('.form-text').text(fileInfo);
            }
        });

        // Student Upload Modal upload button click handler
        $('#modalUploadStudentDataBtn').on('click', function () {
            handleModalFileUpload();
        });

        // Student Upload Modal drag and drop functionality
        const modalUploadSection = $('.modal-student-upload-section');

        modalUploadSection.on('dragover', function (e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });

        modalUploadSection.on('dragleave', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });

        modalUploadSection.on('drop', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');

            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                $('#modalStudentDataFile')[0].files = files;
                $('#modalUploadStudentDataBtn').prop('disabled', false);

                // Trigger change event to show file info
                $('#modalStudentDataFile').trigger('change');
            }
        });

        // Reset Student Upload Modal when closed
        $('#studentUploadModal').on('hidden.bs.modal', function () {
            $('#modalStudentDataFile').val('');
            $('#modalUploadStudentDataBtn').prop('disabled', true);
            $('#modalUploadStatus').hide();
            $('.upload-progress').remove();
        });

        // Load assigned students when Student Upload Modal is shown
        $('#studentUploadModal').on('shown.bs.modal', function () {
            const convocationId = $(this).data('convocation-id');
            if (convocationId) {
                loadAssignedStudents(convocationId);
            }
        });

        // Refresh students button click handler
        $('#refreshStudentsBtn').on('click', function () {
            const convocationId = $('#studentUploadModal').data('convocation-id');
            if (convocationId) {
                loadAssignedStudents(convocationId);
            }
        });

        // Letter Generation Modal template selection handler
        $('#modalApplicationTemplate').on('change', function () {
            const templateId = $(this).val();
            $('#modalGenerateLetterBtn').prop('disabled', !templateId);
        });

        // Letter Generation Modal generate button click handler
        $('#modalGenerateLetterBtn').on('click', function () {
            generateModalConvocationLetter();
        });

        // Reset Letter Generation Modal when closed
        $('#letterGenerationModal').on('hidden.bs.modal', function () {
            $('#modalApplicationTemplate').val('');
            $('#modalGenerateLetterBtn').prop('disabled', true);
            $('#modalLetterGenerationStatus').hide();
        });

        // Prevent closing parent modal when closing studentSearchModal
        $('#studentSearchModal').on('hidden.bs.modal', function (e) {
            // Only hide the search modal, do not affect the parent modal
            $('body').addClass('modal-open');
        });

        // Initial load
        loadConvocations();
    });
</script>
{% endblock %}