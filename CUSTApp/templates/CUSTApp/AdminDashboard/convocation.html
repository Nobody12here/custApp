{% extends 'CUSTApp/AdminDashboard/base.html' %}
{% load static %}

{% block title %}Convocation Management{% endblock %}

{% block extra_css %}
<style>
    .datetime-modification select.form-control {
        margin-bottom: 0;
    }

    .modal-header .close {
        padding: 0.5rem 1rem;
        margin: -1rem -1rem -1rem auto;
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        opacity: 0.8;
        background: none;
        border: none;
        transition: opacity 0.3s ease;
    }

    .modal-header .close:hover {
        opacity: 1;
        color: #000;
        cursor: pointer;
    }

    /* Base Styles */
    .card-stats {
        cursor: pointer;
        transition: transform 0.2s;
        min-width: 220px;
        max-width: 300px;
    }

    /* Form Styles */
    .convocation-form {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.14);
        margin-bottom: 30px;
    }

    .convocation-form .form-group {
        margin-bottom: 1rem;
    }

    .convocation-form label {
        color: #555;
        font-weight: 500;
    }

    .convocation-form .form-control {
        border-radius: 4px;
        border: 1px solid #ddd;
        padding: 10px 12px;
        height: auto;
    }

    .convocation-form .form-control:focus {
        border-color: #0A369D;
        box-shadow: 0 0 0 0.2rem rgba(10, 54, 157, 0.25);
    }

    /* Table Styles */
    .table th {
        font-weight: 500;
        color: #0A369D;
    }

    /* Button Styles */
    .btn {
        padding: 8px 16px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .btn i.material-icons {
        font-size: 18px;
        vertical-align: middle;
    }

    /* Status Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        text-transform: capitalize;
        font-size: 13px;
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }

    .status-badge.active {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.inactive {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-badge.upcoming {
        background-color: #fff3cd;
        color: #856404;
    }

    /* Modal Styles */
    .modal-content {
        border: none;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        border-bottom: 1px solid #eee;
        padding: 20px;
    }

    .modal-title {
        font-weight: 600;
        color: #0A369D;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        border-top: 1px solid #eee;
        padding: 15px 20px;
    }

    /* Detail Items */
    .detail-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #0A369D;
    }

    .detail-item h6 {
        color: #0A369D;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #dee2e6;
    }

    .detail-item p {
        margin-bottom: 10px;
        display: flex;
    }

    .detail-item p strong {
        min-width: 120px;
        display: inline-block;
    }

    /* Enhanced Input Fields */
    .convocation-form .form-control {
        border-radius: 6px;
        border: 2px solid #ddd;
        padding: 8px 12px;
        height: auto;
        font-size: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .convocation-form .form-control:focus {
        border-color: #0A369D;
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.15);
        outline: none;
    }

    /* Form Group Enhancements */
    .convocation-form .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .convocation-form label {
        color: #555;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 14px;
        letter-spacing: 0.5px;
    }

    /* Textarea Styling */
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    /* Search Input Enhancement */
    #searchInput {
        border-radius: 30px;
        border: 2px solid #ddd;
        padding: 10px 20px;
        font-size: 15px;
        transition: all 0.3s ease;
    }

    #searchInput:focus {
        border-color: #0A369D;
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.15);
        outline: none;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .detail-item p {
            flex-direction: column;
        }

        .detail-item p strong {
            min-width: auto;
            margin-bottom: 5px;
        }
    }

    /* Animation for form toggle */
    #ConvocationFormRow {
        transition: all 0.3s cubic-bezier(.4, 0, .2, 1);
    }

    .form-control.is-invalid {
        border-color: #dc3545;
    }

    .form-control.is-valid {
        border-color: #28a745;
    }

    .invalid-feedback {
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
        display: block;
    }

    .valid-feedback {
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #28a745;
        display: block;
    }

    /* Student Upload Section */
    .student-upload-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 2px dashed #ddd;
        transition: border-color 0.3s ease;
    }

    .student-upload-section:hover {
        border-color: #0A369D;
    }

    .student-upload-section.dragover {
        border-color: #0A369D;
        background-color: rgba(10, 54, 157, 0.05);
    }

    .btn-upload {
        width: 100%;
        height: 45px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-upload:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-upload:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .upload-status .alert {
        margin-bottom: 0;
        border-radius: 6px;
        font-size: 14px;
    }

    .upload-progress {
        margin-top: 10px;
    }

    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
    }

    .progress-bar {
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    /* File input styling */
    input[type="file"].form-control {
        padding: 10px 12px;
        border: 2px solid #ddd;
        background: white;
        cursor: pointer;
    }

    input[type="file"].form-control:focus {
        border-color: #0A369D;
        box-shadow: 0 0 0 3px rgba(10, 54, 157, 0.15);
    }

    input[type="file"].form-control::file-selector-button {
        background: #0A369D;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        margin-right: 12px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s ease;
    }

    input[type="file"].form-control::file-selector-button:hover {
        background: #1E88E5;
    }

    /* Dropdown Styles */
    .dropdown-toggle::after {
        display: none;
    }

    .dropdown-menu {
        border-radius: 6px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        border: none;
        padding: 0.5rem 0;
        min-width: 180px;
    }

    .dropdown-item {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: #f8f9fa;
        color: #0A369D;
    }

    .dropdown-item i.material-icons {
        font-size: 18px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Add New Convocation Button -->
<div class="row">
    <div class="col-md-12 text-right mb-3 mt-3">
        <button id="toggleConvocationForm" class="btn btn-primary">
            <i class="material-icons">add</i> Add New Convocation Instance
        </button>
    </div>
</div>

<!-- Add New Convocation Form (hidden by default) -->
<div class="row" id="ConvocationFormRow" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Add Convocation</h4>
                <p class="card-category">Enter convocation details to create a new instance</p>
            </div>
            <div class="card-body">
                <form id="convocationForm" class="convocation-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="convocationTitle">Convocation Title</label>
                                <input type="text" class="form-control" id="convocationTitle" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="academicYear">Academic Year</label>
                                <input type="text" class="form-control" id="academicYear" placeholder="e.g., 2023-2024"
                                    required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="registrationDate">Registration Start Date</label>
                                <input type="date" class="form-control" id="registrationDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="registrationDeadline">Registration Deadline</label>
                                <input type="date" class="form-control" id="registrationDeadline" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rehearsalDate">Rehearsal Date</label>
                                <input type="date" class="form-control" id="rehearsalDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rehearsalTime">Rehearsal Time</label>
                                <input type="time" class="form-control" id="rehearsalTime" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="convocationDate">Convocation Date</label>
                                <input type="date" class="form-control" id="convocationDate" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="description">Description (Optional)</label>
                                <textarea class="form-control" id="description" rows="3"
                                    placeholder="Enter convocation description..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <button type="submit" class="btn btn-primary">
                            <i class="material-icons">send</i> Create Convocation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Convocation Instances Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Convocation Instances</h4>
                <p class="card-category">Manage all convocation instances</p>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="form-group mb-0">
                            <input type="text" class="form-control" id="searchInput"
                                placeholder="Search convocations...">
                        </div>
                    </div>
                    <div class="col-md-4 text-right">
                        <button id="filterActive" class="btn btn-info">
                            <i class="material-icons">check_circle</i> Active Only
                        </button>
                        <button id="clearFilters" class="btn btn-secondary ml-2">
                            <i class="material-icons">clear</i> Clear Filters
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead class="text-primary">
                            <tr>
                                <th>Title</th>
                                <th>Academic Year</th>
                                <th>Registration Deadline</th>
                                <th>Rehearsal Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="convocationTableBody">
                            <!-- Convocation instances will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" role="dialog" aria-labelledby="viewDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailsModalLabel">Convocation Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-item">
                            <h6>General Information</h6>
                            <p><strong>Title:</strong> <span id="detail-title"></span></p>
                            <p><strong>Academic Year:</strong> <span id="detail-academic-year"></span></p>
                            <p><strong>Status:</strong> <span id="detail-status"></span></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-item">
                            <h6>Important Dates</h6>
                            <p><strong>Registration Start:</strong> <span id="detail-registration-date"></span></p>
                            <p><strong>Registration Deadline:</strong> <span id="detail-registration-deadline"></span>
                            </p>
                            <p><strong>Rehearsal:</strong> <span id="detail-rehearsal-datetime"></span></p>
                            <p><strong>Convocation :</strong> <span id="detail-convocation-datetime"></span></p>

                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="detail-item">
                            <h6>Additional Information</h6>
                            <p><strong>Registration Form:</strong> <a id="detail-form-link" href="#"
                                    target="_blank">Open Form</a></p>
                            <p><strong>Description:</strong> <span id="detail-description"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Student Data Upload Modal -->
<div class="modal fade" id="studentUploadModal" tabindex="-1" role="dialog" aria-labelledby="studentUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentUploadModalLabel">
                    <i class="material-icons" style="vertical-align: middle;">cloud_upload</i>
                    Student Data Upload
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="detail-item">
                            <h6>Convocation Information</h6>
                            <p><strong>Title:</strong> <span id="upload-convocation-title"></span></p>
                            <p><strong>Academic Year:</strong> <span id="upload-academic-year"></span></p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="modalStudentDataFile">Select Student Data File</label>
                            <div class="modal-student-upload-section">
                                <div class="row">
                                    <div class="col-md-8">
                                        <input type="file" class="form-control" id="modalStudentDataFile"
                                            accept=".csv,.xlsx,.xls" placeholder="Select student data file...">
                                        <small class="form-text text-muted">
                                            Supported formats: CSV, Excel (.xlsx, .xls). File should contain student
                                            information including registration numbers, names, and convocation details.
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-primary btn-upload"
                                            id="modalUploadStudentDataBtn">
                                            <i class="material-icons">cloud_upload</i> Upload File
                                        </button>
                                    </div>
                                </div>
                                <div class="upload-status" id="modalUploadStatus" style="display: none;">
                                    <div class="alert alert-info mt-2" role="alert">
                                        <span id="modalUploadStatusMessage"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Letter Generation Modal -->
<div class="modal fade" id="letterGenerationModal" tabindex="-1" role="dialog" aria-labelledby="letterGenerationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="letterGenerationModalLabel">
                    <i class="material-icons" style="vertical-align: middle;">description</i>
                    Convocation Letter Generation
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="detail-item">
                            <h6>Convocation Information</h6>
                            <p><strong>Title:</strong> <span id="letter-convocation-title"></span></p>
                            <p><strong>Academic Year:</strong> <span id="letter-academic-year"></span></p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="modalApplicationLetterSelect">Select Application Letter Template</label>
                            <div class="detail-item">
                                <h6>Letter Generation Options</h6>
                                <div class="row">
                                    <div class="col-md-8">
                                        <select class="form-control" id="modalApplicationLetterSelect">
                                            <option value="">Select an application letter template...</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            Choose the application letter template that will be used for generating convocation letters. Only exam department applications are shown.
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-info btn-block" id="modalLoadApplicationsBtn">
                                            <i class="material-icons">refresh</i> Load Templates
                                        </button>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <span id="modalApplicationCount">0</span> templates available
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="generateConvocationLetterFromModal()">
                    <i class="material-icons">picture_as_pdf</i> Generate Letter Sample
                </button>
                <button type="button" class="btn btn-warning" onclick="bulkGenerateLettersFromModal()">
                    <i class="material-icons">description</i> Generate All Letters
                </button>
                <button type="button" class="btn btn-info" onclick="sendConvocationEmailsFromModal()">
                    <i class="material-icons">email</i> Send Email Invitations
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validation functions
    function showValidationFeedback(inputId, isValid, message) {
        const input = $(`#${inputId}`);
        const feedbackElement = input.siblings('.invalid-feedback, .valid-feedback');

        // Remove existing classes
        input.removeClass('is-valid is-invalid');
        feedbackElement.remove();

        if (isValid) {
            input.addClass('is-valid');
            if (message) {
                input.after(`<div class="valid-feedback">${message}</div>`);
            }
        } else {
            input.addClass('is-invalid');
            input.after(`<div class="invalid-feedback">${message}</div>`);
        }
    }

    function validateDates() {
        const registrationDate = $('#registrationDate').val();
        const registrationDeadline = $('#registrationDeadline').val();
        const rehearsalDate = $('#rehearsalDate').val();

        let isValid = true;

        if (registrationDate && registrationDeadline) {
            if (new Date(registrationDate) >= new Date(registrationDeadline)) {
                showValidationFeedback('registrationDeadline', false, 'Deadline must be after registration start date');
                isValid = false;
            } else {
                showValidationFeedback('registrationDeadline', true, '');
            }
        }

        if (registrationDeadline && rehearsalDate) {
            if (new Date(registrationDeadline) > new Date(rehearsalDate)) {
                showValidationFeedback('rehearsalDate', false, 'Rehearsal date should be after registration deadline');
                isValid = false;
            } else {
                showValidationFeedback('rehearsalDate', true, '');
            }
        }

        return isValid;
    }

    function validateForm() {
        let isFormValid = true;

        // Validate required fields
        const requiredFields = ['convocationTitle', 'academicYear', 'registrationDate', 'registrationDeadline', 'rehearsalDate', 'rehearsalTime', ];

        requiredFields.forEach(fieldId => {
            const value = $(`#${fieldId}`).val();
            if (!value || value.trim() === '') {
                showValidationFeedback(fieldId, false, 'This field is required');
                isFormValid = false;
            } else {
                showValidationFeedback(fieldId, true, '');
            }
        });

        // Validate dates
        if (!validateDates()) {
            isFormValid = false;
        }

        return isFormValid;
    }

    function loadConvocations(searchTerm = '', showActiveOnly = false) {
        let url = '/convocation/';
        if (showActiveOnly) {
            url += '?active_only=true';
        }

        $.ajax({
            url: url,
            method: 'GET',
            success: function (data) {
                const tbody = $('#convocationTableBody');
                tbody.empty();

                const filteredConvocations = searchTerm ? data.filter(convocation => {
                    const searchStr = `${convocation.title} ${convocation.academic_year} ${convocation.status}`.toLowerCase();
                    return searchStr.includes(searchTerm.toLowerCase());
                }) : data;

                if (filteredConvocations.length === 0) {
                    tbody.html('<tr><td colspan="6" class="text-center">No convocation instances found</td></tr>');
                    return;
                }

                filteredConvocations.forEach(convocation => {
                    const registrationDeadline = new Date(convocation.registration_deadline);
                    const rehearsalDate = new Date(convocation.rehearsal_date);
                    const rehearsalTime = convocation.rehearsal_time;

                    const deadlineStr = registrationDeadline.toLocaleDateString();
                    const rehearsalDateStr = rehearsalDate.toLocaleDateString();

                    const row = `
                        <tr>
                            <td>${convocation.title}</td>
                            <td>${convocation.academic_year}</td>
                            <td>${deadlineStr}</td>
                            <td>${rehearsalDateStr} ${rehearsalTime}</td>
                            <td>
                                <span class="status-badge ${convocation.status.toLowerCase()}">
                                    ${convocation.status}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick="viewConvocationDetails(${convocation.id})">
                                    <i class="material-icons">visibility</i> View
                                </button>
                                <div class="dropdown d-inline-block ml-2">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton${convocation.id}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="material-icons">more_vert</i>
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton${convocation.id}">
                                        <a class="dropdown-item" href="#" onclick="openStudentUploadModal(${convocation.id})">
                                            <i class="material-icons">cloud_upload</i> Upload Student Data
                                        </a>
                                        <a class="dropdown-item" href="#" onclick="openLetterGenerationModal(${convocation.id})">
                                            <i class="material-icons">description</i> Generate Letters
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            },
            error: function () {
                $('#convocationTableBody').html('<tr><td colspan="6" class="text-center">Error loading convocation instances</td></tr>');
            }
        });
    }

    // File upload functionality
    function handleFileUpload() {
        const fileInput = $('#studentDataFile')[0];
        const file = fileInput.files[0];
        console.log(file);
        if (!file) {
            showUploadStatus('error', 'Please select a file to upload');
            return;
        }

        // Validate file type
        const allowedTypes = ['.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        if (!allowedTypes.includes(fileExtension)) {
            showUploadStatus('error', 'Invalid file type. Please select a CSV or Excel file.');
            return;
        }

        // Validate file size (max 10MB)
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            showUploadStatus('error', 'File size too large. Maximum allowed size is 10MB.');
            return;
        }

        const formData = new FormData();
        formData.append('convocation_data', file);

        // Get current convocation ID from modal (you might need to store this when opening modal)
        const convocationId = $('#studentUploadModal').data('convocation-id');
        console.log("Convocation ID:", convocationId);
        if (convocationId) {
            formData.append('convocation_id', convocationId);
        }

        // Show upload progress
        showUploadStatus('info', 'Uploading file...', true);
        $('#uploadStudentDataBtn').prop('disabled', true).html('<i class="material-icons">hourglass_empty</i> Uploading...');

        $.ajax({
            url: '/api/upload-convocation-data/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: formData,
            processData: false,
            contentType: false,
            xhr: function () {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function (evt) {
                    if (evt.lengthComputable) {
                        const percentComplete = Math.round((evt.loaded / evt.total) * 100);
                        updateUploadProgress(percentComplete);
                    }
                }, false);
                return xhr;
            },
            success: function (response) {
                const processedCount = response.result.modified || 0;
                const errorCount = response.result.total || 0;

                if (errorCount > 0) {
                    showUploadStatus('warning',
                        `File uploaded with ${errorCount} errors. ${processedCount} records processed successfully.`);
                } else {
                    showUploadStatus('success',
                        `File uploaded successfully! ${processedCount} student records processed.`);
                }

                // Reset file input
                fileInput.value = '';
                $('#uploadStudentDataBtn').prop('disabled', true);

                // Show detailed results if available
                if (response.errors && response.errors.length > 0) {
                    showDetailedErrors(response.errors);
                }
            },
            error: function (xhr) {
                let errorMessage = 'Failed to upload file';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.status === 413) {
                    errorMessage = 'File too large. Please reduce file size and try again.';
                } else if (xhr.status === 400) {
                    errorMessage = 'Invalid file format or data. Please check your file and try again.';
                }
                showUploadStatus('error', errorMessage);
            },
            complete: function () {
                $('#uploadStudentDataBtn').prop('disabled', false).html('<i class="material-icons">cloud_upload</i> Upload File');
                hideUploadProgress();
            }
        });
    }

    function showUploadStatus(type, message, showProgress = false) {
        const statusDiv = $('#uploadStatus');
        const messageSpan = $('#uploadStatusMessage');
        const alertDiv = statusDiv.find('.alert');

        // Remove existing alert classes
        alertDiv.removeClass('alert-success alert-danger alert-info alert-warning');

        // Add appropriate class
        switch (type) {
            case 'success':
                alertDiv.addClass('alert-success');
                break;
            case 'error':
                alertDiv.addClass('alert-danger');
                break;
            case 'warning':
                alertDiv.addClass('alert-warning');
                break;
            default:
                alertDiv.addClass('alert-info');
        }

        messageSpan.text(message);
        statusDiv.show();

        if (showProgress) {
            showUploadProgress();
        }

        // Auto-hide success/error messages after 8 seconds
        if (type === 'success' || type === 'error') {
            setTimeout(() => {
                statusDiv.fadeOut();
            }, 8000);
        }
    }

    function showUploadProgress() {
        const progressHtml = `
            <div class="upload-progress mt-2">
                <div class="progress">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <span class="sr-only">0% Complete</span>
                    </div>
                </div>
                <small class="text-muted">Uploading... <span id="progress-percent">0%</span></small>
            </div>
        `;
        $('#uploadStatus .alert').after(progressHtml);
    }

    function updateUploadProgress(percent) {
        const progressBar = $('.progress-bar');
        const progressText = $('#progress-percent');

        progressBar.css('width', percent + '%').attr('aria-valuenow', percent);
        progressText.text(percent + '%');

        // Update progress bar color based on completion
        if (percent < 50) {
            progressBar.removeClass('bg-warning bg-success').addClass('bg-primary');
        } else if (percent < 90) {
            progressBar.removeClass('bg-primary bg-success').addClass('bg-warning');
        } else {
            progressBar.removeClass('bg-primary bg-warning').addClass('bg-success');
        }
    }

    function hideUploadProgress() {
        $('.upload-progress').remove();
    }

    function showDetailedErrors(errors) {
        if (errors.length === 0) return;

        const errorModal = `
            <div class="modal fade" id="uploadErrorModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Upload Errors</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted">The following errors occurred during file processing:</p>
                            <div class="error-list" style="max-height: 400px; overflow-y: auto;">
                                ${errors.slice(0, 20).map(error => `<div class="alert alert-warning small">${error}</div>`).join('')}
                            </div>
                            ${errors.length > 20 ? `<p class="text-muted"><em>... and ${errors.length - 20} more errors</em></p>` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing error modal if any
        $('#uploadErrorModal').remove();

        // Add and show new error modal
        $('body').append(errorModal);
        $('#uploadErrorModal').modal('show');

        // Auto-remove modal when hidden
        $('#uploadErrorModal').on('hidden.bs.modal', function () {
            $(this).remove();
        });
    }

    function viewConvocationDetails(convocationId) {
        $.ajax({
            url: `/convocation/${convocationId}/`,
            method: 'GET',
            success: function (convocation) {
                const registrationDate = new Date(convocation.registration_date);
                const registrationDeadline = new Date(convocation.registration_deadline);
                const rehearsalDate = new Date(convocation.rehearsal_date);
                const convocationDate = new Date(convocation.convocation_date);
                $('#detail-title').text(convocation.title);
                $('#detail-academic-year').text(convocation.academic_year);
                $('#detail-status').text(convocation.status)
                    .removeClass('active inactive upcoming')
                    .addClass(convocation.status.toLowerCase());
                $('#detail-registration-date').text(registrationDate.toLocaleDateString());
                $('#detail-registration-deadline').text(registrationDeadline.toLocaleDateString());
                $('#detail-convocation-datetime').text(`${convocationDate.toLocaleDateString()}`);
                $('#detail-rehearsal-datetime').text(`${rehearsalDate.toLocaleDateString()} at ${convocation.rehearsal_time}`);
                $('#detail-form-link').attr('href', convocation.registration_form_link);
                $('#detail-description').text(convocation.description || 'No description provided');

                $('#viewDetailsModal').modal('show');
            },
            error: function (xhr) {
                alert('Failed to load convocation details');
                console.error(xhr);
            }
        });
    }

    // New functions for separate modals
    function openStudentUploadModal(convocationId) {
        $.ajax({
            url: `/convocation/${convocationId}/`,
            method: 'GET',
            success: function (convocation) {
                $('#upload-convocation-title').text(convocation.title);
                $('#upload-academic-year').text(convocation.academic_year);
                
                // Store convocation ID
                $('#studentUploadModal').data('convocation-id', convocationId);
                
                // Reset upload section
                $('#modalStudentDataFile').val('');
                $('#modalUploadStudentDataBtn').prop('disabled', true);
                $('#modalUploadStatus').hide();
                
                $('#studentUploadModal').modal('show');
            },
            error: function (xhr) {
                alert('Failed to load convocation details');
                console.error(xhr);
            }
        });
    }

    function openLetterGenerationModal(convocationId) {
        $.ajax({
            url: `/convocation/${convocationId}/`,
            method: 'GET',
            success: function (convocation) {
                $('#letter-convocation-title').text(convocation.title);
                $('#letter-academic-year').text(convocation.academic_year);
                
                // Store convocation ID
                $('#letterGenerationModal').data('convocation-id', convocationId);
                
                // Load application templates
                loadApplicationTemplatesForModal();
                
                $('#letterGenerationModal').modal('show');
            },
            error: function (xhr) {
                alert('Failed to load convocation details');
                console.error(xhr);
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Application Letter Template Functions
    function loadApplicationTemplates() {
        const button = $('#loadApplicationsBtn');
        const originalText = button.html();
        const select = $('#applicationLetterSelect');
        const countSpan = $('#applicationCount');
        
        button.disabled = true;
        button.html('<i class="material-icons">hourglass_empty</i> Loading...');
        
        $.ajax({
            url: '/api/application',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(response) {
                // Clear existing options
                select.empty();
                select.append('<option value="">Select an application letter template...</option>');
                const data = response.filter(app => app.dept_name === 'Examination');
                if (data.length > 0) {
                    data.forEach(function(app) {
                        const option = `<option value="${app.id}" data-name="${app.name}" data-description="${app.description}">
                            ${app.short_name}
                        </option>`;
                        select.append(option);
                    });
                    
                    countSpan.text(data.length);
                    select.prop('disabled', false);
                } else {
                    select.append('<option value="" disabled>No exam department applications found</option>');
                    countSpan.text('0');
                    select.prop('disabled', true);
                }
            },
            error: function(xhr) {
                let errorMessage = 'Failed to load application templates';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                
                select.empty();
                select.append('<option value="" disabled>Error loading templates</option>');
                countSpan.text('0');
                select.prop('disabled', true);
                
                console.error('Error loading applications:', errorMessage);
                alert(errorMessage);
            },
            complete: function() {
                button.disabled = false;
                button.html(originalText);
            }
        });
    }

    function getSelectedApplicationTemplate() {
        const select = $('#applicationLetterSelect');
        const selectedValue = select.val();
        
        if (!selectedValue) {
            return null;
        }
        
        const selectedOption = select.find('option:selected');
        return {
            id: selectedValue,
            name: selectedOption.data('name'),
            description: selectedOption.data('description')
        };
    }

    // Functions for modal-based operations
    function loadApplicationTemplatesForModal() {
        const button = $('#modalLoadApplicationsBtn');
        const originalText = button.html();
        const select = $('#modalApplicationLetterSelect');
        const countSpan = $('#modalApplicationCount');
        
        button.disabled = true;
        button.html('<i class="material-icons">hourglass_empty</i> Loading...');
        
        $.ajax({
            url: '/api/application/',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(response) {
                select.empty();
                select.append('<option value="">Select an application letter template...</option>');
                const data = response.filter(app => app.dept_name === 'Examination');

                if (response.length > 0) {
                    data.forEach(function(app) {
                        const option = `<option value="${app.id}" data-name="${app.name}" data-description="${app.description}">
                            ${app.short_name}
                        </option>`;
                        select.append(option);
                    });
                    
                    countSpan.text(data.length);
                    select.prop('disabled', false);
                } else {
                    select.append('<option value="" disabled>No exam department applications found</option>');
                    countSpan.text('0');
                    select.prop('disabled', true);
                }
            },
            error: function(xhr) {
                let errorMessage = 'Failed to load application templates';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                
                select.empty();
                select.append('<option value="" disabled>Error loading templates</option>');
                countSpan.text('0');
                select.prop('disabled', true);
                
                console.error('Error loading applications:', errorMessage);
                alert(errorMessage);
            },
            complete: function() {
                button.disabled = false;
                button.html(originalText);
            }
        });
    }

    function getSelectedApplicationTemplateFromModal() {
        const select = $('#modalApplicationLetterSelect');
        const selectedValue = select.val();
        
        if (!selectedValue) {
            return null;
        }
        
        const selectedOption = select.find('option:selected');
        return {
            id: selectedValue,
            name: selectedOption.data('name'),
            description: selectedOption.data('description')
        };
    }

    function handleModalFileUpload() {
        const fileInput = $('#modalStudentDataFile')[0];
        const file = fileInput.files[0];

        if (!file) {
            showUploadStatusModal('error', 'Please select a file to upload');
            return;
        }

        // Validate file type
        const allowedTypes = ['.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        if (!allowedTypes.includes(fileExtension)) {
            showUploadStatusModal('error', 'Invalid file type. Please select a CSV or Excel file.');
            return;
        }

        // Validate file size (max 10MB)
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            showUploadStatusModal('error', 'File size too large. Maximum allowed size is 10MB.');
            return;
        }

        const formData = new FormData();
        formData.append('convocation_data', file);

        const convocationId = $('#studentUploadModal').data('convocation-id');
        if (convocationId) {
            formData.append('convocation_id', convocationId);
        }

        showUploadStatusModal('info', 'Uploading file...', true);
        $('#modalUploadStudentDataBtn').prop('disabled', true).html('<i class="material-icons">hourglass_empty</i> Uploading...');

        $.ajax({
            url: '/api/upload-convocation-data/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                const processedCount = response.result.modified || 0;
                const errorCount = response.result.total || 0;

                if (errorCount > 0) {
                    showUploadStatusModal('warning',
                        `File uploaded with ${errorCount} errors. ${processedCount} records processed successfully.`);
                } else {
                    showUploadStatusModal('success',
                        `File uploaded successfully! ${processedCount} student records processed.`);
                }

                fileInput.value = '';
                $('#modalUploadStudentDataBtn').prop('disabled', true);
            },
            error: function (xhr) {
                let errorMessage = 'Failed to upload file';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                showUploadStatusModal('error', errorMessage);
            },
            complete: function () {
                $('#modalUploadStudentDataBtn').prop('disabled', false).html('<i class="material-icons">cloud_upload</i> Upload File');
            }
        });
    }

    function showUploadStatusModal(type, message, showProgress = false) {
        const statusDiv = $('#modalUploadStatus');
        const messageSpan = $('#modalUploadStatusMessage');
        const alertDiv = statusDiv.find('.alert');

        alertDiv.removeClass('alert-success alert-danger alert-info alert-warning');

        switch (type) {
            case 'success':
                alertDiv.addClass('alert-success');
                break;
            case 'error':
                alertDiv.addClass('alert-danger');
                break;
            case 'warning':
                alertDiv.addClass('alert-warning');
                break;
            default:
                alertDiv.addClass('alert-info');
        }

        messageSpan.text(message);
        statusDiv.show();

        if (type === 'success' || type === 'error') {
            setTimeout(() => {
                statusDiv.fadeOut();
            }, 8000);
        }
    }

    // Convocation Letter Generation Functions
    function generateConvocationLetter() {
        const convocationId = $('#viewDetailsModal').data('convocation-id');
        if (!convocationId) {
            alert('No convocation selected');
            return;
        }

        // Check if application template is selected
        const selectedTemplate = getSelectedApplicationTemplate();
        if (!selectedTemplate) {
            alert('Please select an application letter template first');
            return;
        }

        // For sample, we'll use a test student ID - in real scenario, you might want to select a student
        const studentId = prompt('Enter student registration number (e.g., BSE203110) for sample letter:');
        if (!studentId) {
            return;
        }

        $.ajax({
            url: '/api/generate-convocation-letter/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            data: {
                convocation_id: convocationId,
                student_id: studentId,
                application_id: selectedTemplate.id
            },
            xhrFields: {
                responseType: 'blob'
            },
            success: function (data) {
                // Create blob and download
                const blob = new Blob([data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Convocation_Letter_${studentId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                alert('Convocation letter generated and downloaded successfully!');
            },
            error: function (xhr) {
                let errorMessage = 'Failed to generate convocation letter';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                alert(errorMessage);
            }
        });
    }

    function bulkGenerateLetters() {
        const convocationId = $('#viewDetailsModal').data('convocation-id');
        if (!convocationId) {
            alert('No convocation selected');
            return;
        }

        if (!confirm('This will generate convocation letters for all students in this convocation. Continue?')) {
            return;
        }

        const button = event.target;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="material-icons">hourglass_empty</i> Generating...';

        $.ajax({
            url: '/api/bulk-generate-convocation-letters/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            data: {
                convocation_id: convocationId
            },
            success: function (response) {
                alert(`Successfully generated ${response.generated_count} convocation letters. ${response.error_count > 0 ? response.error_count + ' errors occurred.' : ''}`);
                if (response.errors && response.errors.length > 0) {
                    console.log('Generation errors:', response.errors);
                }
            },
            error: function (xhr) {
                let errorMessage = 'Failed to generate convocation letters';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                alert(errorMessage);
            },
            complete: function () {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });
    }

    function sendConvocationEmails() {
        const convocationId = $('#viewDetailsModal').data('convocation-id');
        if (!convocationId) {
            alert('No convocation selected');
            return;
        }

        if (!confirm('This will send convocation invitation emails to all students. Continue?')) {
            return;
        }

        const button = event.target;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="material-icons">hourglass_empty</i> Sending...';

        $.ajax({
            url: '/api/send-convocation-emails/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            data: {
                convocation_id: convocationId
            },
            success: function (response) {
                alert(`Successfully sent ${response.sent_count} convocation emails. ${response.error_count > 0 ? response.error_count + ' emails failed to send.' : ''}`);
                if (response.errors && response.errors.length > 0) {
                    console.log('Email errors:', response.errors);
                }
            },
            error: function (xhr) {
                let errorMessage = 'Failed to send convocation emails';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                alert(errorMessage);
            },
            complete: function () {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });
    }

    // Letter generation functions for modal
    function generateConvocationLetterFromModal() {
        const convocationId = $('#letterGenerationModal').data('convocation-id');
        if (!convocationId) {
            alert('No convocation selected');
            return;
        }

        const selectedTemplate = getSelectedApplicationTemplateFromModal();
        if (!selectedTemplate) {
            alert('Please select an application letter template first');
            return;
        }

        const studentId = prompt('Enter student registration number (e.g., BSE203110) for sample letter:');
        if (!studentId) {
            return;
        }

        $.ajax({
            url: '/api/generate-convocation-letter/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            data: {
                convocation_id: convocationId,
                student_id: studentId,
                application_id: selectedTemplate.id
            },
            xhrFields: {
                responseType: 'blob'
            },
            success: function (data) {
                const blob = new Blob([data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Convocation_Letter_${studentId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                alert('Convocation letter generated and downloaded successfully!');
            },
            error: function (xhr) {
                let errorMessage = 'Failed to generate convocation letter';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                alert(errorMessage);
            }
        });
    }

    function bulkGenerateLettersFromModal() {
        const convocationId = $('#letterGenerationModal').data('convocation-id');
        if (!convocationId) {
            alert('No convocation selected');
            return;
        }

        const selectedTemplate = getSelectedApplicationTemplateFromModal();
        if (!selectedTemplate) {
            alert('Please select an application letter template first');
            return;
        }

        if (!confirm(`This will generate convocation letters for all students using the template "${selectedTemplate.name}". Continue?`)) {
            return;
        }

        const button = event.target;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="material-icons">hourglass_empty</i> Generating...';

        $.ajax({
            url: '/api/bulk-generate-convocation-letters/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            data: {
                convocation_id: convocationId,
                application_id: selectedTemplate.id
            },
            success: function (response) {
                alert(`Successfully generated ${response.generated_count} convocation letters. ${response.error_count > 0 ? response.error_count + ' errors occurred.' : ''}`);
                if (response.errors && response.errors.length > 0) {
                    console.log('Generation errors:', response.errors);
                }
            },
            error: function (xhr) {
                let errorMessage = 'Failed to generate convocation letters';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                alert(errorMessage);
            },
            complete: function () {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });
    }

    function sendConvocationEmailsFromModal() {
        const convocationId = $('#letterGenerationModal').data('convocation-id');
        if (!convocationId) {
            alert('No convocation selected');
            return;
        }

        if (!confirm('This will send convocation invitation emails to all students. Continue?')) {
            return;
        }

        const button = event.target;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="material-icons">hourglass_empty</i> Sending...';

        $.ajax({
            url: '/api/send-convocation-emails/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            data: {
                convocation_id: convocationId
            },
            success: function (response) {
                alert(`Successfully sent ${response.sent_count} convocation emails. ${response.error_count > 0 ? response.error_count + ' emails failed to send.' : ''}`);
                if (response.errors && response.errors.length > 0) {
                    console.log('Email errors:', response.errors);
                }
            },
            error: function (xhr) {
                let errorMessage = 'Failed to send convocation emails';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                alert(errorMessage);
            },
            complete: function () {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });
    }

    $(document).ready(function () {
        if (!checkAuth()) return;

        // Date validation on change
        $('#registrationDate, #registrationDeadline, #rehearsalDate').on('change', function () {
            validateDates();
        });

        // Real-time validation for required fields
        $('input[required], select[required]').on('blur', function () {
            const value = $(this).val();
            const fieldId = $(this).attr('id');

            if (!value || value.trim() === '') {
                showValidationFeedback(fieldId, false, 'This field is required');
            } else {
                showValidationFeedback(fieldId, true, '');
            }
        });

        // URL validation
        $('#registrationFormLink').on('blur', function () {
            const url = $(this).val();
            if (url) {
                try {
                    new URL(url);
                    showValidationFeedback('registrationFormLink', true, '');
                } catch {
                    showValidationFeedback('registrationFormLink', false, 'Please enter a valid URL');
                }
            }
        });

        // Form submission
        $('#convocationForm').on('submit', function (e) {
            e.preventDefault();
            console.log('Form submitted');
            if (!validateForm()) {
                const firstInvalid = $('.is-invalid').first();
                if (firstInvalid.length) {
                    $('html, body').animate({
                        scrollTop: firstInvalid.offset().top - 100
                    }, 300);
                    firstInvalid.focus();
                }
                return false;
            }

            const formData = {
                title: $('#convocationTitle').val(),
                academic_year: $('#academicYear').val(),
                registration_date: $('#registrationDate').val(),
                registration_deadline: $('#registrationDeadline').val(),
                rehearsal_date: $('#rehearsalDate').val(),
                rehearsal_time: $('#rehearsalTime').val(),
                convocation_date: $('#convocationDate').val(),
                description: $('#description').val()
            };

            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.text();
            submitBtn.prop('disabled', true).text('Creating...');

            $.ajax({
                url: '/convocation/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: formData,
                success: function (response, textStatus, jqXHR) {
                    if (jqXHR.status === 201) {
                        alert('Convocation instance created successfully');
                        $('#convocationForm')[0].reset();
                        $('.is-valid, .is-invalid').removeClass('is-valid is-invalid');
                        $('.invalid-feedback, .valid-feedback').remove();
                        loadConvocations();
                        $('#ConvocationFormRow').slideUp();
                    } else {
                        alert(response.error || 'Failed to create convocation instance');
                    }
                },
                error: function (xhr) {
                    let errorMessage = 'An error occurred while creating the convocation instance';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    alert(errorMessage);
                },
                complete: function () {
                    submitBtn.prop('disabled', false).text(originalText);
                }
            });
        });

        // Search functionality
        $('#searchInput').on('input', function () {
            loadConvocations($(this).val());
        });

        // Filter buttons
        $('#filterActive').on('click', () => loadConvocations('', true));
        $('#clearFilters').on('click', () => loadConvocations('', false));

        // Toggle form
        $('#toggleConvocationForm').on('click', function () {
            $('#ConvocationFormRow').slideToggle(200);
        });

        // File input change handler
        $('#studentDataFile').on('change', function () {
            const file = this.files[0];
            console.log(file);
            $('#uploadStudentDataBtn').prop('disabled', !file);

            if (file) {
                // Hide any previous status
                $('#uploadStatus').hide();

                // Show file info
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const fileInfo = `Selected: ${file.name} (${fileSize} MB)`;
                $(this).next('.form-text').text(fileInfo);
            }
        });

        // Upload button click handler
        $('#uploadStudentDataBtn').on('click', function () {
            console.log('Upload button clicked');
            handleFileUpload();
        });

        // Drag and drop functionality
        const uploadSection = $('.student-upload-section');

        uploadSection.on('dragover', function (e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });

        uploadSection.on('dragleave', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });

        uploadSection.on('drop', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');

            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                $('#studentDataFile')[0].files = files;
                $('#uploadStudentDataBtn').prop('disabled', false);

                // Trigger change event to show file info
                $('#studentDataFile').trigger('change');
            }
        });

        // Reset upload section when modal is closed
        $('#viewDetailsModal').on('hidden.bs.modal', function () {
            $('#studentDataFile').val('');
            $('#uploadStudentDataBtn').prop('disabled', true);
            $('#uploadStatus').hide();
            $('.upload-progress').remove();
        });

        // Event handlers for new modal functionality
        
        // Student Upload Modal file input change handler
        $('#modalStudentDataFile').on('change', function () {
            const file = this.files[0];
            $('#modalUploadStudentDataBtn').prop('disabled', !file);

            if (file) {
                // Hide any previous status
                $('#modalUploadStatus').hide();

                // Show file info
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const fileInfo = `Selected: ${file.name} (${fileSize} MB)`;
                $(this).next('.form-text').text(fileInfo);
            }
        });

        // Student Upload Modal upload button click handler
        $('#modalUploadStudentDataBtn').on('click', function () {
            handleModalFileUpload();
        });

        // Student Upload Modal drag and drop functionality
        const modalUploadSection = $('.modal-student-upload-section');

        modalUploadSection.on('dragover', function (e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });

        modalUploadSection.on('dragleave', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });

        modalUploadSection.on('drop', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');

            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                $('#modalStudentDataFile')[0].files = files;
                $('#modalUploadStudentDataBtn').prop('disabled', false);

                // Trigger change event to show file info
                $('#modalStudentDataFile').trigger('change');
            }
        });

        // Reset Student Upload Modal when closed
        $('#studentUploadModal').on('hidden.bs.modal', function () {
            $('#modalStudentDataFile').val('');
            $('#modalUploadStudentDataBtn').prop('disabled', true);
            $('#modalUploadStatus').hide();
            $('.upload-progress').remove();
        });

        // Letter Generation Modal template selection handler
        $('#modalApplicationTemplate').on('change', function () {
            const templateId = $(this).val();
            $('#modalGenerateLetterBtn').prop('disabled', !templateId);
        });

        // Letter Generation Modal generate button click handler
        $('#modalGenerateLetterBtn').on('click', function () {
            generateModalConvocationLetter();
        });

        // Reset Letter Generation Modal when closed
        $('#letterGenerationModal').on('hidden.bs.modal', function () {
            $('#modalApplicationTemplate').val('');
            $('#modalGenerateLetterBtn').prop('disabled', true);
            $('#modalLetterGenerationStatus').hide();
        });

        // Initial load
        loadConvocations();
    });
</script>
{% endblock %}