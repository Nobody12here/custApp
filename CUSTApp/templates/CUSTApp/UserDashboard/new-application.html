{% extends 'base.html' %}
{% load static %}

{% block title %}CUST App - New Application{% endblock %}

{% block extra_css %}
<style>
  .file-input-wrapper {
    position: relative;
    display: inline-block;
  }

  .file-input {
    position: absolute;
    top: 0;
    right: 0;
    opacity: 0;
    cursor: pointer;
  }

  .file-name {
    padding: 5px 10px;
    border: 1px solid #ccc;
    display: inline-block;
    margin-top: 10px;
    color: #555;
  }
</style>
{% endblock %}

{% block content %}
<div class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header card-header-primary">
            <h4 class="card-title">Submit New Application</h4>
            <p class="card-category">Complete the form below</p>
          </div>
          <div class="card-body">
            <form id="applicationForm">
              <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <label class="bmd-label-floating"></label>
                    <select class="form-control" id="applicationType" name="applicationType">
                      <option value="">Select Application Type</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="bmd-label-floating">Student Name</label>
                    <input type="text" class="form-control" id="studentName" disabled value="Tania Andrew">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="bmd-label-floating">Student RegNo</label>
                    <input type="text" class="form-control" id="studentId" name="studentId" required>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <label class="bmd-label-floating">Comments</label>
                    <textarea class="form-control" rows="3" id="comments" name="comments"></textarea>
                  </div>
                </div>
              </div>
              <!-- File Upload Button -->
              <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <label for="fileUpload">Upload File</label>
                    <div class="file-input-wrapper">
                      <input type="file" class="file-input" id="fileUpload" name="file" />
                      <div class="file-name" id="fileName">No file selected</div>
                    </div>
                  </div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary pull-right">Submit Application</button>
              <div class="clearfix"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    if (!checkAuth()) return;

    // Load application types into the select dropdown
    function loadApplicationTypes() {
      $.ajax({
        url: `/api/applications/`,
        method: 'GET',
        success: function (response) {
          const select = $('#applicationType');
          response.forEach(app => {
            select.append(`<option value="${app.id}">${app.name}</option>`);
          });
        },
        error: function (xhr, status, error) {
          console.error('Error fetching application types:', error);
          alert('Failed to load application types. Please try again later.');
        }
      });
    }

    // Handle form submission
    $('#applicationForm').submit(function (e) {
      e.preventDefault();

      const applicationId = $('#applicationType').val();
      const studentId = $('#studentId').val();
      const comments = $('#comments').val();
      const file = $('#fileUpload')[0].files[0];

      if (!applicationId || !studentId) {
        alert('Please select an application type and enter your student ID.');
        return;
      }

      const formData = new FormData();
      formData.append('applicationID', applicationId);
      formData.append('studentID', studentId);
      formData.append('comments', comments);
      if (file) formData.append('request_file', file);

      $.ajax({
        url: `/api/application-request/`,
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          alert(response.message);
          $('#applicationForm')[0].reset();
          $('#applicationType').html('<option value="">Select Application Type</option>');
          loadApplicationTypes();
          $('#fileName').text('No file selected');
        },
        error: function (xhr, status, error) {
          console.error('Error submitting application:', error);
          alert('Failed to submit application: ' + (xhr.responseJSON?.message || 'Unknown error'));
        }
      });
    });

    // Update file name display when a file is selected
    $('#fileUpload').change(function () {
      const fileName = this.files.length > 0 ? this.files[0].name : 'No file selected';
      $('#fileName').text(fileName);
    });

    loadApplicationTypes();
  });
</script>
{% endblock %}