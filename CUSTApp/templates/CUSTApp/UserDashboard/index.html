{% extends 'base.html' %}
{% load static %}

{% block title %}CUST App Dashboard{% endblock %}

{% block extra_css %}
<style>
  .modal-textarea {
    width: 100%;
    min-height: 150px;
  }

  .chat-modal .modal-body {
    max-height: 400px;
    overflow-y: auto;
    padding-bottom: 10px;
  }

  .chat-message {
    margin: 10px 15px;
    padding: 10px;
    border-radius: 10px;
    max-width: 70%;
    word-wrap: break-word;
  }

  .chat-message.student {
    background-color: #e1ffc7;
    margin-left: auto;
    text-align: right;
  }

  .chat-message.employee {
    background-color: #f0f0f0;
    margin-right: auto;
  }

  .chat-message .name {
    font-weight: bold;
    font-size: 0.9em;
  }

  .chat-message .timestamp {
    font-size: 0.7em;
    color: #666;
    margin-top: 5px;
  }

  .chat-input-container {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
  }

  .chat-input {
    flex-grow: 1;
    border-radius: 20px;
    padding: 10px;
    margin-right: 10px;
  }

  .chat-send-btn {
    border-radius: 50%;
    padding: 10px;
  }
</style>
{% endblock %}

{% block content %}
<div class="row" id="application-cards"></div>

<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header card-header-primary">
        <h4 class="card-title">Requests List</h4>
        <p class="card-category">Manage all incoming requests</p>
      </div>
      <div class="card-body">
        <form id="search-form" class="mb-3">
          <input type="text" id="search-input" class="form-control" placeholder="Search by request type, student name, or comments...">
        </form>
        <div class="table-responsive">
          <table class="table">
            <thead class="text-primary">
              <tr>
                <th>Request Type</th>
                <th>Student Name</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
                <th>Attachments</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody id="requestTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Comment Modal -->
<div class="modal fade chat-modal" id="commentModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Comments</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" id="chatBody"></div>
      <div class="modal-footer chat-input-container">
        <input type="text" class="form-control chat-input" id="chatInput" placeholder="Type your comment...">
        <button type="button" class="btn btn-primary chat-send-btn" onclick="saveComment()">
          <i class="material-icons">send</i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Rendered Template</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <textarea class="form-control modal-textarea" id="templateModalTextarea" rows="6"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateTemplate()">Update</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let allPendingRequests = [];

  $(document).ready(function () {
    if (!checkAuth()) return;

    // Application stats
    $.ajax({
      url: '/api/applications/',
      method: 'GET',
      success: function (data) {
        const colors = ['warning', 'rose', 'success', 'info', 'primary', 'danger'];
        const icons = ['description', 'language', 'school', 'verified_user', 'attach_money', 'people'];

        data.forEach((item, index) => {
          $('#application-cards').append(`
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header card-header-${colors[index % colors.length]} card-header-icon">
                  <div class="card-icon"><i class="material-icons">${icons[index % icons.length]}</i></div>
                  <p class="card-category">${item.name}</p>
                  <h3 class="card-title">${item.count ?? 0}</h3>
                </div>
              </div>
            </div>
          `);
        });
      }
    });

    loadRequests();

    $('#search-form').on('submit', function (e) {
      e.preventDefault();
      renderRequests(allPendingRequests, $('#search-input').val().toLowerCase());
    });

    $('#search-input').on('input', function () {
      renderRequests(allPendingRequests, $(this).val().toLowerCase());
    });
  });

  function loadRequests() {
    $.get('/requests/', function (requests) {
      allPendingRequests = requests.filter(r => r.status === 'Pending');
      renderRequests(allPendingRequests);
    });
  }

  function renderRequests(requests, searchTerm = '') {
    const tbody = $('#requestTableBody').empty();
    const filtered = searchTerm
      ? requests.filter(req =>
          (req.application_name || '').toLowerCase().includes(searchTerm) ||
          (`Student ${req.StudentID || req.applicant}`).toLowerCase().includes(searchTerm) ||
          (req.status || '').toLowerCase().includes(searchTerm) ||
          (req.comments || []).map(c => c.text).join(' ').toLowerCase().includes(searchTerm))
      : requests;

    if (!filtered.length) {
      tbody.append(`<tr><td colspan="7">No pending requests found.</td></tr>`);
      return;
    }

    filtered.forEach(req => {
      const name = req.StudentID ? `Student ${req.StudentID}` : `Applicant ${req.applicant}`;
      const template = (req.renderedtemplate || '').replace(/"/g, '&quot;');
      const comments = encodeURIComponent(JSON.stringify(req.comments || []));
      const date = new Date(req.created_at).toLocaleDateString();

      tbody.append(`
        <tr data-request-id="${req.request_id}">
          <td>${req.application_name}</td>
          <td>${name}</td>
          <td>${date}</td>
          <td class="request-status">${req.status}</td>
          <td>
            <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#templateModal" onclick="openTemplateModal('${template}')">View</button>
            <button class="btn btn-success btn-sm" onclick="updateStatus(${req.request_id}, 'Approved')">Accept</button>
            <button class="btn btn-danger btn-sm" onclick="updateStatus(${req.request_id}, 'Rejected')">Reject</button>
          </td>
          <td>--</td>
          <td>
            <button class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#commentModal" onclick="openCommentsModal(${req.request_id}, '${comments}')">
              <i class="material-icons">comment</i>
            </button>
          </td>
        </tr>
      `);
    });
  }

  function updateStatus(id, status) {
    $.post(`/update-request-status/${id}/`, { status }, (res) => {
      if (res.success) {
        alert(`Request ${status.toLowerCase()} successfully`);
        loadRequests();
      } else {
        alert(res.error || `Failed to update request`);
      }
    }).fail(() => alert('Error updating request'));
  }

  function openTemplateModal(template) {
    $('#templateModalTextarea').val(decodeURIComponent(template));
  }

  function updateTemplate() {
    alert('Template updated! (Demo purpose)');
    $('#templateModal').modal('hide');
  }

  let currentRequestIdForComments = null;

  function openCommentsModal(id, commentsEncoded) {
    currentRequestIdForComments = id;
    const comments = JSON.parse(decodeURIComponent(commentsEncoded));
    const chatBody = $('#chatBody').empty();

    comments.forEach(c => {
      const sender = c.is_student ? 'student' : 'employee';
      chatBody.append(`
        <div class="chat-message ${sender}">
          <div class="name">${c.sender}</div>
          <div>${c.text}</div>
          <div class="timestamp">${new Date(c.timestamp).toLocaleString()}</div>
        </div>
      `);
    });
  }

  function saveComment() {
    const text = $('#chatInput').val();
    if (!text) return;

    $.post(`/add-comment/${currentRequestIdForComments}/`, { text }, (res) => {
      if (res.success) {
        $('#chatInput').val('');
        $('#commentModal').modal('hide');
        loadRequests();
      } else {
        alert(res.error || 'Failed to add comment');
      }
    }).fail(() => alert('Error adding comment'));
  }
</script>
{% endblock %}
